<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Biểu đồ dữ liệu nước</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    body { font-family: sans-serif; margin: 20px; }
    .controls { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <h2>Biểu đồ nhiệt độ và độ đục theo thời gian</h2>

    <div class="controls">
        <label>Từ: <input type="date" id="from-date"></label>
        <label>Đến: <input type="date" id="to-date"></label>
        <button onclick="loadHistory()">Lọc dữ liệu</button>
        <button onclick="enableRealtime()">Chế độ thời gian thực</button>
    </div>

    <canvas id="myChart" width="600" height="300"></canvas>

    <script>
    const labels = []; // thời gian
    const tempData = []; // nhiệt độ
    const turbData = []; // độ đục

    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
        labels: labels,
        datasets: [
            {
                label: 'Nhiệt độ (°C)',
                data: tempData,
                borderWidth: 2,
                borderColor: 'red',
                fill: false
            },
            {
                label: 'Độ đục (ADC)',
                data: turbData,
                borderWidth: 2,
                borderColor: 'blue',
                fill: false
            }
        ]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Thời gian'
                    }
                },
                y: {
                beginAtZero: true
                }
            }
        }
    });

    // 📡 Nhận dữ liệu thời gian thực qua WebSocket
    const socket = new WebSocket('ws://localhost:3000');
    let isRealtimeMode = true; // Biến để kiểm soát chế độ realtime

    socket.onmessage = (event) => {
    if (!isRealtimeMode) return; // Bỏ qua nếu không ở chế độ realtime

    const json = JSON.parse(event.data);
    console.log('Realtime:', json);

    // Chỉ hiển thị ngày, bỏ giờ
    const dateOnly = json.timestamp.split(' ')[0] || json.timestamp.split('T')[0];
    labels.push(dateOnly);
    tempData.push(json.temperature);
    turbData.push(json.turbidity);

    // Chỉ giữ lại 10 điểm gần nhất
    if (labels.length > 10) {
        labels.shift();
        tempData.shift();
        turbData.shift();
    }

    myChart.update();
    };

    // 📥 Tải dữ liệu cũ từ Firebase thông qua server
    async function loadHistory() {
        const from = document.getElementById('from-date').value;
        const to = document.getElementById('to-date').value;
        if (!from || !to) {
        alert('Vui lòng chọn cả ngày bắt đầu và kết thúc!');
        return;
        }

        // Tắt chế độ realtime khi lọc dữ liệu
        isRealtimeMode = false;

        try {
            const response = await fetch(`http://localhost:3000/data_sensor?from=${from}&to=${to}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Dữ liệu lịch sử:', data);

            // Xoá dữ liệu cũ trên biểu đồ
            labels.length = 0;
            tempData.length = 0;
            turbData.length = 0;

            data.forEach(d => {
            // Chỉ hiển thị ngày, bỏ giờ
            const dateOnly = d.timestamp.split(' ')[0] || d.timestamp.split('T')[0];
            labels.push(dateOnly);
            tempData.push(d.temperature);
            turbData.push(d.turbidity);
            });
            myChart.update();
        } catch (error) {
            console.error('Lỗi khi tải dữ liệu:', error);
            alert('Không thể tải dữ liệu. Vui lòng kiểm tra server!');
            // Bật lại realtime nếu có lỗi
            isRealtimeMode = true;
        }
    }

    function enableRealtime() {
        isRealtimeMode = true;
        
        labels.length = 0;
        tempData.length = 0;
        turbData.length = 0;

        // Tự động cập nhật ngày hôm qua và hôm nay
        const today = new Date();
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        
        // Chuyển đổi thành định dạng YYYY-MM-DD theo múi giờ địa phương
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        document.getElementById('to-date').value = formatDate(today);
        document.getElementById('from-date').value = formatDate(yesterday);

        myChart.update();
        console.log('Đã bật chế độ thời gian thực');
    }

    // �🕒 Tự động set ngày hôm nay và hôm qua
    window.onload = () => {
        const today = new Date();
        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
        
        // Chuyển đổi thành định dạng YYYY-MM-DD theo múi giờ địa phương
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        document.getElementById('to-date').value = formatDate(today);
        document.getElementById('from-date').value = formatDate(yesterday);
    };
</script>
</body>
</html>
